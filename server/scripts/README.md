# 管理员密钥管理脚本

## 问题诊断

### 1. 检查管理员密钥信息

运行此脚本查看所有管理员的密钥配置情况：

```bash
cd server
node scripts/check-admin-keys.js
```

**输出示例：**
```
========== 检查所有管理员密钥信息 ==========

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
管理员: admin
ID: 1
邮箱: admin@example.com
创建时间: 2025-01-15 10:30:00

✅ 有密钥信息:
  公钥X: D5548C7825CBB56150A3506CD57464AF8A1AE0519DFAF3C58221DC810CAF28DD
  公钥Y: 921073768FE3D59CE54E79A49445CF73FED23086537027264D168946D479533E
  PIN码(加密): $2a$10$xxxxxxxxxxxxx...
  创建时间: 2025-01-15 10:30:00
  更新时间: 2025-01-15 10:30:00

  登录时需要输入PIN码进行验证
```

### 2. 更新管理员PIN码

如果您忘记了PIN码或需要更改，运行此脚本：

```bash
cd server
node scripts/update-admin-pin.js
```

**使用方法：**

1. 打开 `server/scripts/update-admin-pin.js`
2. 修改以下两行：
   ```javascript
   const username = 'admin'; // 修改为您的管理员用户名
   const newPinCode = '123'; // 修改为您想要的PIN码
   ```
3. 保存并运行脚本

**输出示例：**
```
正在为用户 admin 更新PIN码...
找到管理员用户: admin (ID: 1)
PIN码已加密: $2a$10$xxxxxxxxxxxxx...
✅ 成功更新管理员 admin 的PIN码为: 123

当前密钥信息:
  公钥X: D5548C7825CBB56150A3506CD57464AF8A1AE0519DFAF3C58221DC810CAF28DD
  公钥Y: 921073768FE3D59CE54E79A49445CF73FED23086537027264D168946D479533E
```

## 常见问题

### Q1: 登录时提示"PIN码不正确"

**原因：** 您输入的PIN码与数据库中存储的不一致

**解决方法：**
1. 运行 `check-admin-keys.js` 确认该管理员有密钥信息
2. 如果有密钥信息但忘记了PIN码，使用 `update-admin-pin.js` 重置
3. 如果没有密钥信息，系统会自动使用默认PIN码 `123`

### Q2: 如何知道应该输入什么PIN码？

**有密钥信息的管理员：**
- 需要输入**创建管理员账号时设置的PIN码**
- 如果忘记了，使用 `update-admin-pin.js` 脚本重置

**没有密钥信息的管理员：**
- **不需要输入**PIN码
- 系统自动使用默认PIN码 `123`
- 使用默认用户名 `bookstore` 和默认公钥

### Q3: 公钥不匹配怎么办？

**原因：** USB Key中的公钥与数据库中存储的不一致

**解决方法：**
1. 确认您插入的是正确的USB Key
2. 检查数据库中存储的公钥是否正确
3. 如果需要更新公钥，需要在管理员界面重新创建管理员账号

## 登录流程说明

### 有密钥信息的管理员
1. 输入用户名、密码
2. 插入USB Key
3. **输入PIN码**（创建账号时设置的）
4. 点击验证按钮
5. 验证通过后登录

### 没有密钥信息的管理员
1. 输入用户名、密码
2. 插入USB Key
3. **无需输入PIN码**（自动使用默认配置）
4. 自动验证
5. 验证通过后登录

## 默认配置

```javascript
默认用户名: bookstore
默认PIN码: 123
默认公钥X: D5548C7825CBB56150A3506CD57464AF8A1AE0519DFAF3C58221DC810CAF28DD
默认公钥Y: 921073768FE3D59CE54E79A49445CF73FED23086537027264D168946D479533E
```


